sudo: required
services:
- docker
env:
  global:
  - DOCKER_USERNAME=bodsch
  - BUILD_DATE=$(date +%Y-%m-%d)
  - BUILD_VERSION=$(date +%y%m)
  - SAMBA_VERSION=$(./hooks/latest_release.sh)
  - secure: fruLn5wcEQE6NAmiEkxP8uw6KNtbgZEys2O67FH+5wSwSupERQ3ekUMRVhE58/nNJ3CILFLdASvntjrlweg2Ex/4aSzPxIuO7jaIfXSYd2EAWvs5DS03Rr2rVDSR6eeZGw8xj8Oob9ZYsgKDx/vlqQrqcQ7YcVm+sAVO4nAqftnNiRjvBvZ2WCG+68why8dOCoANP2BpL+3GBe1TRQGUSsQG2PRznsNuofC/nLahFYguDPW2rlTUQc3GXrcGhwTj4Pm9Y2aSUWTtpXMnJuRLxKceBjjFXbeIw3Qde0wj69/Hn0o9/AaBrlgOfXrMu5uQE4yCWfbSK8qKywE3TTmclpRq5KYsCbqDt4Inm3WePfuyO4yYU957Zl/E++N0rvZ+FjJGggh3bfggwJ0Zy/9vu+7k97Zg7kuhlt5sHws2ZcRXi8ahFj3CDmwmDNtbNjKeZB9z+qjn+WUnes4y4ingpsLT6mIskrLP0+D0EUaG6z5Is667wpG988QHZw0yGTV8R+lERUDk+kolkFMgdh3/STLrjxjR8sl3WPRa7zI2Jp2rK3vv+1R4b23P3ZnZgHC7kAHKq4YZ5dLhmr3975btOtf3vic7NpPC5jAieScAf039J2S87wbHCKvwnBqa3DL/UTLl4AOfntCYQQxZB8CZo4kltwLGxwYguyCP6EX1eEc=
jobs:
  include:
  - stage: build
    script:
    - make
  - stage: test
    script:
    - make compose-file
    - docker-compose up --build -d
    - sleep 15s
    - make test
    - docker-compose down
  - stage: push latest docker image
    script:
    - make
    - docker login -u="${DOCKER_USERNAME}" -p="${DOCKER_PASSWORD}"
    - docker tag ${USER}/samba4:latest ${DOCKER_USERNAME}/docker-samba4:latest
    - docker push ${DOCKER_USERNAME}/docker-samba4:latest
    - docker logout
  - stage: push version docker image
    if: branch = master
    script:
    - make
    - docker login -u="${DOCKER_USERNAME}" -p="${DOCKER_PASSWORD}"
    - docker tag ${USER}/samba4:latest ${DOCKER_USERNAME}/docker-samba4:${SAMBA_VERSION}
    - docker push ${DOCKER_USERNAME}/docker-samba4:${SAMBA_VERSION}
    - docker logout
